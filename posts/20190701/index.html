<!doctype html><html><head><title>Spring JDBCのbatchUpdateはどのへんが効率的なのか // J'aime les ramens</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Spring JDBCのbatchUpdateはどのへんが効率的なのか"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:locale" content="en"><meta property="og:url" content="https://yuizho.github.io/blog/posts/20190701/"><link rel="shortcut icon" href=/favicon.ico><link href=https://yuizho.github.io/blog/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://yuizho.github.io/blog/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://yuizho.github.io/blog/css/style.css><meta name=generator content="Hugo 0.61.0"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a><a id=logo class=logo-text href=https://yuizho.github.io/blog/>J'aime les ramens</a><nav id=main-nav><a class=main-nav-link href=https://yuizho.github.io/blog/tags>Tags</a>
<a class=main-nav-link href=https://yuizho.github.io/blog/about>About</a></nav><nav id=sub-nav></nav></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>Spring JDBCのbatchUpdateはどのへんが効率的なのか</h1></header><div class=article-meta><a href=/blog/posts/20190701/ class=article-date><time datetime=2019-07-01T13:33:15.000+00:00 itemprop=datePublished>2019-07-01</time></a></div><div class=article-entry itemprop=articleBody><h1 id=overview>Overview</h1><p>spring jdbc使っていて、batchUpdateというのがあることに気がついた。</p><p>ドキュメントを見ていると複数のデータを登録していくときは効率的っぽいことが書いてあったけど、どう効率的なのかがよくわからなかったのでし
らべてみた</p><p><a href=https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html#batchUpdate-java.lang.String-org.springframework.jdbc.core.BatchPreparedStatementSetter->https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html#batchUpdate-java.lang.String-org.springframework.jdbc.core.BatchPreparedStatementSetter-</a>
<a href=https://docs.spring.io/spring-framework/docs/3.0.0.RC3/spring-framework-reference/html/ch12s04.html>https://docs.spring.io/spring-framework/docs/3.0.0.RC3/spring-framework-reference/html/ch12s04.html</a></p><h1 id=heading>実際の動きを確認</h1><p>最初にこんな感じのテーブルと、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> product(
   	id INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
   	division INT(<span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
   	created DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
   	name VARCHAR(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
   	<span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>(id),
   	<span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>KEY</span> uk_product (division, created)
   );
</code></pre></div><p>こんな感じのコードを用意してどんなSQLが発行されるか試してみた</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#a6e22e>@Repository</span>
   <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductRepositoryImpl</span> <span style=color:#66d9ef>implements</span> ProductRepository <span style=color:#f92672>{</span>
       <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> NamedParameterJdbcTemplate jdbcTemplate<span style=color:#f92672>;</span>
   
       <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductRepositoryImpl</span><span style=color:#f92672>(</span>NamedParameterJdbcTemplate jdbcTemplate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>jdbcTemplate</span> <span style=color:#f92672>=</span> jdbcTemplate<span style=color:#f92672>;</span>
       <span style=color:#f92672>}</span>
   
       <span style=color:#a6e22e>@Override</span>
       <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>batchInsert</span><span style=color:#f92672>(</span>List<span style=color:#f92672>&lt;</span>Product<span style=color:#f92672>&gt;</span> producs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           String sql <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INSERT INTO product (division, created, name) &#34;</span>  
                   <span style=color:#e6db74>&#34;VALUES(:division, :created, :name)&#34;</span><span style=color:#f92672>;</span>
           jdbcTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>batchUpdate</span><span style=color:#f92672>(</span>sql<span style=color:#f92672>,</span>
                   producs<span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>(</span><span style=color:#f92672>)</span>
                           <span style=color:#f92672>.</span><span style=color:#a6e22e>map</span><span style=color:#f92672>(</span>p <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>
                                   <span style=color:#66d9ef>new</span> MapSqlParameterSource<span style=color:#f92672>(</span><span style=color:#f92672>)</span>
                                           <span style=color:#f92672>.</span><span style=color:#a6e22e>addValue</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;division&#34;</span><span style=color:#f92672>,</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>getDivision</span><span style=color:#f92672>(</span><span style=color:#f92672>)</span><span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>INTEGER</span><span style=color:#f92672>)</span>
                                           <span style=color:#f92672>.</span><span style=color:#a6e22e>addValue</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;created&#34;</span><span style=color:#f92672>,</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>getCreated</span><span style=color:#f92672>(</span><span style=color:#f92672>)</span><span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>TIMESTAMP</span><span style=color:#f92672>)</span>
                                           <span style=color:#f92672>.</span><span style=color:#a6e22e>addValue</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(</span><span style=color:#f92672>)</span><span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>CHAR</span><span style=color:#f92672>)</span>
                           <span style=color:#f92672>)</span> <span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span>SqlParameterSource<span style=color:#f92672>[</span><span style=color:#f92672>]</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#66d9ef>new</span><span style=color:#f92672>)</span>
           <span style=color:#f92672>)</span><span style=color:#f92672>;</span>
       <span style=color:#f92672>}</span>
   <span style=color:#f92672>}</span>
</code></pre></div><p>上記のコードを実行して、Mysqlのログから実際発行されたSQLを確認してみる</p><ul><li>参考: <a href=https://tableplus.io/blog/2018/10/how-to-show-queries-log-in-mysql.html>https://tableplus.io/blog/2018/10/how-to-show-queries-log-in-mysql.html</a></li></ul><pre><code>| 2019-06-08 18:44:31.192892 | test[test] @  [xxx.xx.xx.xx] |        69 |         0 | Query        | INSERT INTO product (division, created, name) VALUES(1, '2019-06-08 18:44:28.159', 'aa')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
| 2019-06-08 18:44:31.196375 | test[test] @  [xxx.xx.xx.xx] |        69 |         0 | Query        | INSERT INTO product (division, created, name) VALUES(1, '2019-06-08 18:44:29.659', 'bb') 
</code></pre><p>まぁそりゃそうだろ感があるが、普通にInsert文が2発飛んでいる
というわけで、Spring JDBCのコードを追っていく。</p><h1 id=spring-jdbc>Spring JDBCのコードを確認</h1><p><a href=https://github.com/spring-projects/spring-framework/blob/master/spring-jdbc/src/main/java/org/springframework/jdbc/core/JdbcTemplate.java#L930>https://github.com/spring-projects/spring-framework/blob/master/spring-jdbc/src/main/java/org/springframework/jdbc/core/JdbcTemplate.java#L930</a></p><p>上記のコードを読んでいくと、PreparedStatement#addBatchでSQLを追加していき、PreparedStatement#executeBatchでまとめてDBへ送信しているようだった。</p><p>どうやら、一度にクエリをDBへ送るという点で、普通にupdateをくるくる回すよりパフォーマンスが優れているということのようだ。</p><p>……と、調べ終わってからそれっぽいことが書いてあるドキュメント(Spring JDBCのじゃないけど)を見つけた。
<a href=https://docs.oracle.com/javase/jp/1.3/guide/jdbc/spec2/jdbc2.1.frame6.html>https://docs.oracle.com/javase/jp/1.3/guide/jdbc/spec2/jdbc2.1.frame6.html</a></p></div><div class=article-toc><h3>Contents</h3><nav id=TableOfContents></nav></div><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://yuizho.github.io/blog//tags/java>Java</a></li><li class=article-tag-list-item><a class=article-tag-list-link href=https://yuizho.github.io/blog//tags/spring>Spring</a></li><li class=article-tag-list-item><a class=article-tag-list-link href=https://yuizho.github.io/blog//tags/tech>tech</a></li></ul></footer></div><nav id=article-nav><a href=/blog/posts/20200101/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
ブログをHugoを使ったものに移行しました</div></a><a href=/blog/posts/20190423/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>MySQLのNOW()とSYSDATE()の違いについて&nbsp;<span>></span></div></a></nav></article></section><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2020 yuizho<br>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos target=_blank>Minos</a></div></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var header=document.getElementById('header');if(header.classList.contains('mobile-on')){header.classList.remove('mobile-on');}else{header.classList.add('mobile-on');}});</script></footer></div></body></html>